<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/layout :: layout('Editar Hecho', ~{::link}, ~{::section})}">
<head>
<!--    <link rel="stylesheet" th:href="@{/css/styles-mis-hechos.css}">-->
    <link rel="stylesheet" th:href="@{/css/styles-subir-hecho.css}">
</head>
<body class="body-metamapa" >
    <section class="mm-form-wrap">
        <div class="mm-card">
            <h1 class="mm-form-title" style="margin:0 0 6px;">Editar hecho</h1>
            <p class="mm-form-sub">Modificá los campos y guardá los cambios</p>

            <div th:if="${ok}" class="alert alert-success" role="alert" th:text="${ok}">Actualizado</div>
            <div th:if="${error}" class="alert alert-danger" role="alert" th:text="${error}">Error</div>

            <!-- Ajustar el action a endpoint de guardado -->
            <form th:object="${hecho}" th:action="@{'/hechos/' + ${hecho.getId() + '/editar'}}"  method="post" enctype="multipart/form-data" class="mm-form">
                <div class="mm-grid mm-grid--2">
                    <!-- Título -->
                    <div class="mm-field mm-col-span-2">
                        <label class="mm-label" for="titulo">Título</label>
                        <input id="titulo" name="titulo" class="mm-input" type="text" required
                               th:value="*{titulo}" maxlength="200">
                    </div>

                    <!-- Descripción -->
                    <div class="mm-field">
                        <label class="mm-label" for="descripcion">Descripción</label>
                        <textarea id="descripcion" name="descripcion" class="mm-input mm-input--textarea" rows="6"
                                  th:text="*{descripcion}"></textarea>
                    </div>

                    <div class="mm-field">
                        <!-- Ubicación (sin mapa) -->
                        <div class="mm-field">
                            <label class="mm-label" for="lat">Latitud</label>
                            <input id="lat" name="lat" class="mm-input" type="number" step="0.000001"
                                   th:field="*{ubicacion.latitud}">
                        </div>
                        <div class="mm-field">
                            <label class="mm-label" for="lng">Longitud</label>
                            <input id="lng" name="lng" class="mm-input" type="number" step="0.000001"
                                   th:field="*{ubicacion.longitud}">
                        </div>
                    </div>
                    <!-- Categoría -->
                    <div class="mm-field">
                        <label for="categoria" class="mm-label">Categoría</label>
                        <select id="categoria" name="categoria" class="mm-input" required th:field="*{categoria.nombre}" th:classappend="${#fields.hasErrors('categoria.nombre')} ? ' is-invalid' : ''" onchange="modificarCategoria(this)">
                            <option value="" disabled selected>Seleccioná una categoría…</option>
                            <option value="EVENTO_SANITARIO">Evento sanitario</option>
                            <option value="">Crear una categoria…</option>
                            <option value="CONTAMINACION">Contaminación</option>
                            <option value="DERRAME">Derrame</option>
                            <th:block th:each="categoriaAgregador : ${categorias}">
                                <option th:text="${categoriaAgregador}" th:value="${categoriaAgregador}"></option>
                            </th:block>
                            <!-- agregá más si aplica -->
                        </select>
                        <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('categoria.nombre')}" th:errors="*{categoria.nombre}">
                            Error en categoría
                        </div>
                    </div>
                    <!-- Fecha acontecimiento -->
                    <div class="mm-field">
                        <label for="fechaAcontecimiento" class="mm-label">Fecha del acontecimiento</label>
                        <input id="fechaAcontecimiento" name="fechaAcontecimiento" type="datetime-local" class="mm-input" required th:field="*{fechaAcontecimiento}" th:classappend="${#fields.hasErrors('fechaAcontecimiento')} ? ' is-invalid' : ''">
                        <span th:text="${'Fecha actual: ' + hecho.fechaAcontecimiento}"></span>
                        <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('fechaAcontecimiento')}" th:errors="*{fechaAcontecimiento}">
                            Error en fecha
                        </div>
                    </div>

                    <div class="mm-field">
                        <label id="categoriaInputLabel" for="categoriaInput" style="display: none;" class="mm-label">Categoría</label>
                        <input id="categoriaInput" style="display: none;" class="mm-input"  type="text">
                    </div>


                    <!-- Imagen (opcional) -->
                    <div class="mm-field mm-col-span-2">
                        <label class="mm-label" for="imagenNueva">Imagen</label>
                        <input id="imagenNueva" multiple name="imagenNueva" type="file" accept="image/*, video/*" class="mm-input mm-input--file" th:field="*{contenidoMultimediaFile}">
                        <small class="mm-help">Si no seleccionás una imagen, se mantiene la actual.</small>
                    </div>
                    <div style="display: none;">
                        <input id="idUsuario" type="number" th:field="*{idUsuario}">
                        <input id="fechaCarga" name="fechaCarga" type="datetime-local"  th:field="*{fechaCarga}">
                    </div>

                    <!-- (Opcional) Fecha de acontecimiento si editás eso -->
    <!--                <div class="mm-field">-->
    <!--                    <label class="mm-label" for="fechaAcontecimiento">Fecha del acontecimiento</label>-->
    <!--                    <input id="fechaAcontecimiento" name="fechaAcontecimiento" class="mm-input" type="date"-->
    <!--                           th:value="${#temporals.format(hecho.fechaAcontecimiento, 'yyyy-MM-dd')}">-->
    <!--                </div>-->
                </div>

                <div class="mm-actions" style="margin-top:14px;">
                    <a class="mm-btn mm-btn-ghost" th:href="@{/hechos/mis-hechos}" role="button">Volver</a>
                    <button class="mm-btn-primary" type="submit">Guardar cambios</button>
                </div>
            </form>
            <script>
                const categoriaSelect = document.getElementById('categoria');
                const categoriaInput = document.getElementById('categoriaInput');
                const categoriaInputLabel = document.getElementById('categoriaInputLabel');

                function modificarCategoria(el) {
                    const option = el.value
                    console.log(el.id)
                    if (option === "") {
                        categoriaSelect.required = false
                        categoriaInput.required = true
                        categoriaInput.style.display = "block"
                        categoriaInputLabel.style.display = "block"
                        categoriaSelect.setAttribute("name", "")
                        categoriaInput.setAttribute("name", "categoria.nombre")
                    } else {
                        categoriaSelect.required = true
                        categoriaInput.required = false
                        categoriaInput.style.display = "none"
                        categoriaInputLabel.style.display = "none"
                        categoriaSelect.setAttribute("name", "categoria.nombre")
                        categoriaInput.setAttribute("name", "")
                    }
                }
            </script>
        </div>
    </section>
</body>
</html>
