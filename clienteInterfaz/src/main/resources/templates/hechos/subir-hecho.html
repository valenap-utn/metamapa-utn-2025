<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subir Hecho</title>

    <link rel="icon" th:href="@{/components/logo-ico.png}">

    <!--  META-TAGS DE COMPARTIR ENLACE  -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://valenap-utn.github.io/landing-page-dds/index.html" />
    <meta property="og:title" content="MetaMapa" />
    <!--    <meta property="og:description" content="Compartí Hechos en MetaMapa" />-->
    <meta property="og:image" content="../components/logo-mm.png" />

    <!-- Fuentes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Archivo:ital,wght@0,100..900;1,100..900&family=Josefin+Sans:ital,wght@0,100..700;1,100..700&family=Lexend:wght@100..900&family=Open+Sans:ital,wght@0,300..800;1,300..800&display=swap" rel="stylesheet">


    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <link th:href="@{/css/styles-subir-hecho.css}" rel="stylesheet">

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Iconos -->
    <script src="https://kit.fontawesome.com/d4dda767ac.js" crossorigin="anonymous"></script>
</head>
<body>
    <section class="mm-form-wrap">
        <div class="mm-card">
            <h1 class="mm-form-title">Subir Hecho</h1>
            <p class="mm-form-sub">Cargá la información del hecho para que quede disponible en MetaMapa</p>

            <form id="form-hecho" class="mm-form" novalidate th:action="@{/hechos/subir-hecho}" method="post" th:object="${hecho}" enctype="multipart/form-data">
                <!-- Progreso -->
                <ol class="mm-steps" role="list" aria-label="Progreso">
                    <li class="is-active" data-step="1"><span>Ubicación</span></li>
                    <li data-step="2"><span>Datos</span></li>
                    <li data-step="3"><span>Multimedia</span></li>
                </ol>
                <div class="mm-progress" aria-hidden="true">
                    <div class="mm-progress__bar" id="progressBar" style="width: 33%"></div>
                </div>

                <!-- PASO 1: Ubicación -->
                <section class="mm-step is-active" data-step="1" aria-labelledby="step1-title">
                    <h2 id="step1-title" class="visually-hidden">Elegí la ubicación</h2>
                    <p class="mm-help mb-2">Hacé click en el mapa para marcar dónde ocurrió el hecho</p>

                    <div id="map" aria-label="Mapa interactivo para seleccionar la ubicación del hecho"></div>

                    <!-- guardamos coordenadas y mostramos un preview -->
                    <input id="lat" type="hidden" required th:field="*{ubicacion.latitud}">
                    <input id="lng" type="hidden" required th:field="*{ubicacion.longitud}">
                    <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('ubicacion.latitud') || #fields.hasErrors('ubicacion.longitud')}">
                        Debés elegir una ubicación en el mapa.
                    </div>

                    <div id="locPreview" class="mm-pill mt-2" hidden>
                        <i class="fa-solid fa-location-dot"></i>
                        <span id="locText">Latitud: — , Longitud: —</span>
                        <button type="button" class="mm-pill__edit" id="btnReubicar" aria-label="Volver a elegir ubicación">Reubicar</button>
                    </div>

                    <div class="mm-actions mt-3">
                        <a th:href="@{/main-gral}" class="mm-btn mm-btn-ghost">
                            <span class="arrow"><i class="fa-solid fa-arrow-left"></i></span>
                        </a>
                        <button type="button" id="btnNext1" class="mm-btn mm-btn-primary" disabled>
                            <span class="arrow"><i class="fa-solid fa-arrow-right"></i></span>
                        </button>
                    </div>
                </section>

                <!-- PASO 2: Datos -->
                <section class="mm-step" data-step="2" aria-labelledby="step2-title">
                    <h2 id="step2-title" class="visually-hidden">Completá los datos del hecho</h2>

                    <div class="mm-grid">
                        <!-- Título -->
                        <div class="mm-field mm-col-span-all">
                            <label for="titulo" class="mm-label">Título</label>
                            <input id="titulo" name="titulo" type="text" class="mm-input" placeholder="Ej: Derrame en ribera del río" required th:field="*{titulo}" th:classappend="${#fields.hasErrors('titulo')} ? ' is-invalid' : ''">
                            <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('titulo')}" th:errors="*{titulo}">
                                Error en título
                            </div>
                        </div>

                        <!-- Categoría -->
                        <div class="mm-field">
                            <label for="categoria" class="mm-label">Categoría</label>
                            <select id="categoria" name="categoria" class="mm-input" required th:field="*{categoria.nombre}" th:classappend="${#fields.hasErrors('categoria.nombre')} ? ' is-invalid' : ''" onchange="modificarCategoria(this)">
                                <option value="" disabled selected>Seleccioná una categoría…</option>
                                <option value="EVENTO_SANITARIO">Evento sanitario</option>
                                <option value="">Crear una categoria…</option>
                                <option value="CONTAMINACION">Contaminación</option>
                                <option value="DERRAME">Derrame</option>
                                <th:block th:each="categoriaAgregador : ${categorias}">
                                    <option th:text="${categoriaAgregador}" th:value="${categoriaAgregador}"></option>
                                </th:block>
                                <!-- agregá más si aplica -->
                            </select>
                            <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('categoria.nombre')}" th:errors="*{categoria.nombre}">
                                Error en categoría
                            </div>
                        </div>
                        <!-- Fecha acontecimiento -->
                        <div class="mm-field">
                            <label for="fechaAcontecimiento" class="mm-label">Fecha del acontecimiento</label>
                            <input id="fechaAcontecimiento" name="fechaAcontecimiento" type="datetime-local" class="mm-input" required th:field="*{fechaAcontecimiento}" th:classappend="${#fields.hasErrors('fechaAcontecimiento')} ? ' is-invalid' : ''">
                            <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('fechaAcontecimiento')}" th:errors="*{fechaAcontecimiento}">
                                Error en fecha
                            </div>
                        </div>

                        <div class="mm-field">
                            <label id="categoriaInputLabel" for="categoriaInput" style="display: none;" class="mm-label">Categoría</label>
                            <input id="categoriaInput" style="display: none;" class="mm-input"  type="text">
                        </div>

                        <!-- Descripción -->
                        <div class="mm-field" style="grid-column: 1 / -1;">
                            <label for="descripcion" class="mm-label">Descripción</label>
                            <textarea id="descripcion" name="descripcion" class="mm-input mm-input--textarea"
                                      minlength="500" required data-min-guest="500" data-min-auth="0"
                                      placeholder="Contá brevemente qué ocurrió…" th:field="*{descripcion}" th:classappend="${#fields.hasErrors('descripcion')} ? ' is-invalid' : ''"></textarea>
<!--                            <div id="descCounter" class="form-text">0 / 500</div>-->
                            <div class="d-flex justify-content-between mt-1">
                                <small id="descReq" class="text-muted"></small>
                                <small id="descCounter" class="text-muted"></small>
                            </div>

                            <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('descripcion')}"
                                 th:errors="*{descripcion}">
                                Error en descripción
                            </div>
                        </div>
                    </div>

                    <div class="mm-actions">
                        <button type="button" id="btnPrev2" class="mm-btn mm-btn-ghost">
                            <span class="arrow"><i class="fa-solid fa-arrow-left"></i></span>
                        </button>
                        <button type="button" id="btnNext2" class="mm-btn mm-btn-primary">
                            <span class="arrow"><i class="fa-solid fa-arrow-right"></i></span>
                        </button>
                    </div>

                </section>

                <!-- PASO 3 (opcional) -->
                <section class="mm-step" data-step="3" aria-labelledby="step3-title">
                    <h2 id="step3-title" class="visually-hidden">Adjuntar multimedia</h2>

                    <div class="mm-field mm-col-span-all">
                        <label class="mm-label">Fotos o videos</label>

                        <div id="dropzone" class="mm-dropzone" tabindex="0" aria-label="Arrastrá y soltá archivos o hacé click para seleccionarlos">
                            <i class="fa-regular fa-images"></i>
                            <p class="m-0">Arrastrá y soltá aquí, o <strong>hace click</strong> para seleccionar</p>
                            <small>Se aceptan imagenes y videos. Podes añadir varios.</small>
                            <input id="mediaInput" type="file" accept="image/*, video/*" multiple hidden th:field="*{contenidoMultimediaFile}">
                        </div>

                        <div id="mediaPreview" class="mm-media-grid" aria-live="polite"></div>
                    </div>

                    <div class="mm-actions">
                        <button type="button" id="btnPrev3" class="mm-btn mm-btn-ghost">
                            <span class="arrow"><i class="fa-solid fa-arrow-left"></i></span>
                        </button>
                        <button type="submit" class="mm-btn mm-btn-primary">Enviar</button>
                    </div>
                </section>
            </form>
        </div>
    </section>

    <script th:src="@{/js/commons.js}"></script>
    <script th:src="@{/js/subir-hecho.js}"></script>
    <script>
        (function(){
            const form = document.getElementById('form-hecho');
            if(!form) return;
            form.addEventListener('submit', function(){
                const submitBtn = form.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = 'Enviando… <i class="fa-solid fa-circle-notch fa-spin"></i>';
                }
            });
        })();
    </script>

</body>
</html>